{% extends "base.html" %}
{% block title %}Ordens de Serviço{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Ordens de Serviço</h2>
  <button class="btn btn-primary" onclick="abrirNovaOrdem()">Nova Ordem</button>
</div>

<table class="table table-striped" id="ordensTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Cliente</th>
      <th>Equipamentos</th>
      <th>Descrição</th>
      <th>Status</th>
      <th>Data de Abertura</th>
      <th>Data de Encerramento</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal Criação / Edição -->
<div class="modal fade" id="ordemModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="ordemForm">
      <div class="modal-header">
        <h5 class="modal-title" id="ordemModalTitulo">Nova Ordem</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="ordemId">

        <label>Cliente</label>
        <select class="form-control mb-2" id="clienteSelect" required>
          <option value="">Selecione...</option>
        </select>

        <label>Equipamentos</label>
        <div class="d-flex flex-wrap gap-2 mb-2" id="equipamentoTags"></div>
        <select class="form-control" id="equipamentoSelect" onchange="adicionarEquipamento()">
          <option value="">Selecione...</option>
        </select>

        <label class="mt-3">Descrição</label>
        <textarea class="form-control" id="descricao" placeholder="Descreva o problema ou serviço..." required></textarea>

        <label class="mt-3">Status</label>
        <select class="form-control" id="status">
          <option>Aberta</option>
          <option>Em andamento</option>
          <option>Fechada</option>
        </select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";
let modoEdicao = false;
let equipamentos = [];
let equipamentosSelecionados = [];

// === Carregar Ordens ===
async function carregarOrdens() {
  const res = await fetch(`${API}/ordens/`);
  const data = await res.json();
  const tbody = document.querySelector("#ordensTable tbody");
  tbody.innerHTML = "";
  data.forEach(o => {
    const eqs = o.equipamentos?.map(e => e.nome || e.modelo || e.tipo).join(", ") || "-";
    tbody.innerHTML += `
      <tr>
        <td>${o.id_os}</td>
        <td>${o.cliente_nome || "—"}</td>
        <td>${eqs}</td>
        <td>${o.descricao || "—"}</td>
        <td>${o.status || "—"}</td>
        <td>${formatarData(o.data_abertura)}</td>
        <td>${o.data_encerramento ? formatarData(o.data_encerramento) : "—"}</td>
        <td>
          <button class="btn btn-sm btn-outline-warning me-2" onclick="abrirEdicao(${o.id_os})">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deletarOrdem(${o.id_os})">Excluir</button>
        </td>
      </tr>`;
  });
}

// === Função para formatar datas ===
function formatarData(dataStr) {
  if (!dataStr) return "";
  const d = new Date(dataStr);
  return d.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric" });
}

// === Carregar Clientes ===
async function carregarClientes() {
  const res = await fetch(`${API}/clientes/`);
  const data = await res.json();
  const select = document.getElementById("clienteSelect");
  select.innerHTML = '<option value="">Selecione...</option>';
  data.forEach(c => {
    const id = c.id ?? c.id_cliente;
    select.innerHTML += `<option value="${id}">${c.nome}</option>`;
  });
}

// === Carregar Equipamentos ===
async function carregarEquipamentos() {
  const res = await fetch(`${API}/equipamentos/`);
  equipamentos = await res.json();
  atualizarDropdown();
}

function atualizarDropdown() {
  const select = document.getElementById("equipamentoSelect");
  select.innerHTML = '<option value="">Selecione...</option>';
  equipamentos
    .filter(e => !equipamentosSelecionados.includes(e.id_equipamento))
    .forEach(e => {
      select.innerHTML += `<option value="${e.id_equipamento}">${e.tipo} ${e.modelo}</option>`;
    });
}

function adicionarEquipamento() {
  const select = document.getElementById("equipamentoSelect");
  const id = parseInt(select.value);
  if (!id || equipamentosSelecionados.includes(id)) return;
  equipamentosSelecionados.push(id);
  renderizarTags();
  atualizarDropdown();
}

function removerEquipamento(id) {
  equipamentosSelecionados = equipamentosSelecionados.filter(e => e !== id);
  renderizarTags();
  atualizarDropdown();
}

function renderizarTags() {
  const container = document.getElementById("equipamentoTags");
  container.innerHTML = "";
  equipamentosSelecionados.forEach(i => {
    const eq = equipamentos.find(e => e.id_equipamento === i);
    const tag = document.createElement("span");
    tag.className = "badge bg-primary p-2";
    tag.innerHTML = `${eq.tipo} ${eq.modelo} <span style="cursor:pointer" onclick="removerEquipamento(${i})">×</span>`;
    container.appendChild(tag);
  });
}

// === Abrir Modal Nova Ordem ===
function abrirNovaOrdem() {
  modoEdicao = false;
  equipamentosSelecionados = [];
  document.getElementById("ordemForm").reset();
  document.getElementById("equipamentoTags").innerHTML = "";
  document.getElementById("ordemId").value = "";
  document.getElementById("ordemModalTitulo").textContent = "Nova Ordem";
  bootstrap.Modal.getOrCreateInstance(document.getElementById("ordemModal")).show();
  atualizarDropdown();
}

// === Abrir Modal Edição ===
async function abrirEdicao(id) {
  modoEdicao = true;
  const res = await fetch(`${API}/ordens/${id}`);
  if (!res.ok) return alert("Ordem não encontrada");
  const ordem = await res.json();

  document.getElementById("ordemId").value = ordem.id_os;
  document.getElementById("clienteSelect").value = ordem.id_cliente;
  document.getElementById("descricao").value = ordem.descricao;
  document.getElementById("status").value = ordem.status;
  equipamentosSelecionados = ordem.equipamentos.map(e => e.id || e.id_equipamento);
  renderizarTags();
  atualizarDropdown();

  document.getElementById("ordemModalTitulo").textContent = "Editar Ordem";
  bootstrap.Modal.getOrCreateInstance(document.getElementById("ordemModal")).show();
}

// === Salvar (Criar ou Editar) ===
document.getElementById("ordemForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const clienteValue = document.getElementById("clienteSelect").value;
  if (!clienteValue || isNaN(clienteValue)) {
    return alert("Selecione um cliente válido!");
  }

  const payload = {
    id_cliente: parseInt(clienteValue),
    equipamentos: equipamentosSelecionados,
    descricao: document.getElementById("descricao").value,
    status: document.getElementById("status").value
  };

  const id = document.getElementById("ordemId").value;
  const method = modoEdicao ? "PUT" : "POST";
  const url = modoEdicao ? `${API}/ordens/${id}` : `${API}/ordens/`;

  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    bootstrap.Modal.getInstance(document.getElementById("ordemModal")).hide();
    await carregarOrdens();
  } else {
    const erro = await res.json();
    alert("Erro ao salvar ordem: " + JSON.stringify(erro.detail || erro));
  }
});

// === Deletar ===
async function deletarOrdem(id) {
  if (!confirm("Deseja realmente excluir esta ordem?")) return;
  await fetch(`${API}/ordens/${id}`, { method: "DELETE" });
  await carregarOrdens();
}

// === Inicialização ===
(async function init() {
  await carregarClientes();
  await carregarEquipamentos();
  await carregarOrdens();
})();
</script>
{% endblock %}
