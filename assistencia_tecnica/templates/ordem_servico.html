{% extends "base.html" %}
{% block title %}Ordens de Serviço{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Ordens de Serviço</h2>
  <button class="btn btn-primary" onclick="abrirNovaOrdem()">Nova Ordem</button>
</div>

<table class="table table-striped" id="ordensTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Cliente</th>
      <th>Equipamento</th>
      <th>Descrição</th>
      <th>Status</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="novaOrdemModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="novaOrdemForm">
      <div class="modal-header">
        <h5 class="modal-title">Nova Ordem de Serviço</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="clienteSelect" class="form-label">Cliente</label>
        <select class="form-control mb-2" id="clienteSelect" name="cliente_id" required></select>

        <label for="equipamentoSelect" class="form-label">Equipamento</label>
        <select class="form-control mb-2" id="equipamentoSelect" name="equipamento_id">
          <option value="">Nenhum equipamento</option>
        </select>

        <textarea class="form-control mb-2" name="descricao" placeholder="Descrição do problema" required></textarea>

        <select class="form-control mb-2" name="status">
          <option value="Aberta">Aberta</option>
          <option value="Em andamento">Em andamento</option>
          <option value="Fechada">Fechada</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";
let ordemAtualId = null; // ID da ordem sendo editada

// --- ORDENS ---
async function carregarOrdens() {
  const res = await fetch(`${API}/ordens/`);
  const data = await res.json();
  const tbody = document.querySelector("#ordensTable tbody");
  tbody.innerHTML = "";
  data.forEach(o => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${o.id_os ?? ""}</td>
      <td>${o.cliente_nome ?? "Cliente inexistente"}</td>
      <td>${o.equipamento_nome ?? "Nenhum"}</td>
      <td>${o.descricao ?? ""}</td>
      <td>${o.status ?? ""}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editarOrdem(${o.id_os})">Editar</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deletarOrdem(${o.id_os})">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// --- CLIENTES ---
async function carregarClientes() {
  const res = await fetch(`${API}/clientes/`);
  const data = await res.json();
  const select = document.getElementById("clienteSelect");
  select.innerHTML = '<option value="">Selecione um cliente</option>';
  data.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id_cliente ?? c.id;
    opt.textContent = `${c.nome} (ID ${c.id_cliente ?? c.id})`;
    select.appendChild(opt);
  });
}

// --- EQUIPAMENTOS ---
async function carregarEquipamentos() {
  const res = await fetch(`${API}/equipamentos/`);
  const data = await res.json();
  const select = document.getElementById("equipamentoSelect");
  select.innerHTML = '<option value="">Nenhum equipamento</option>';
  data.forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.id ?? e.id_equipamento;
    opt.textContent = `${e.nome ?? e.tipo ?? "Equipamento"} (${e.modelo ?? "modelo desconhecido"})`;
    select.appendChild(opt);
  });
}

// --- ABRIR MODAL NOVA ORDEM ---
function abrirNovaOrdem() {
  ordemAtualId = null;
  const form = document.getElementById("novaOrdemForm");
  form.reset();
  document.querySelector("#novaOrdemModal .modal-title").textContent = "Nova Ordem de Serviço";
  bootstrap.Modal.getOrCreateInstance(document.getElementById("novaOrdemModal")).show();
}

// --- EDITAR ---
async function editarOrdem(id) {
  const res = await fetch(`${API}/ordens/${id}`);
  const o = await res.json();
  ordemAtualId = id;

  const form = document.getElementById("novaOrdemForm");
  form.cliente_id.value = o.id_cliente;
  form.equipamento_id.value = o.equipamento_id ?? "";
  form.descricao.value = o.descricao;
  form.status.value = o.status;

  document.querySelector("#novaOrdemModal .modal-title").textContent = "Editar Ordem de Serviço";
  bootstrap.Modal.getOrCreateInstance(document.getElementById("novaOrdemModal")).show();
}

// --- CRIAÇÃO / ATUALIZAÇÃO ---
document.getElementById("novaOrdemForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    id_cliente: parseInt(form.cliente_id.value),
    equipamento_id: form.equipamento_id.value ? parseInt(form.equipamento_id.value) : null,
    descricao: form.descricao.value,
    status: form.status.value
  };

  if (ordemAtualId) {
    // Atualização
    const res = await fetch(`${API}/ordens/${ordemAtualId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      console.error("Erro ao atualizar:", await res.text());
      alert("Erro ao atualizar ordem. Verifique o console (F12).");
      return;
    }
  } else {
    // Criação
    const res = await fetch(`${API}/ordens/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      console.error("Erro ao criar:", await res.text());
      alert("Erro ao criar ordem. Verifique o console (F12).");
      return;
    }
  }

  ordemAtualId = null;
  form.reset();
  bootstrap.Modal.getInstance(document.getElementById("novaOrdemModal")).hide();
  await carregarOrdens();
});

// --- DELEÇÃO ---
async function deletarOrdem(id) {
  await fetch(`${API}/ordens/${id}`, { method: "DELETE" });
  await carregarOrdens();
}

// --- INICIALIZAÇÃO ---
(async function init() {
  await carregarClientes();
  await carregarEquipamentos();
  await carregarOrdens();
})();
</script>
{% endblock %}
