{% extends "base.html" %}
{% block title %}Funcionários{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Funcionários</h2>
  <input type="text" id="buscaFuncionario" class="form-control w-50 me-3" placeholder="Buscar por nome ou CNPJ">
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoFuncionarioModal">Novo Funcionário</button>
</div>

<table class="table table-striped" id="funcionariosTable">
  <thead>
    <tr>
      <th>ID</th><th>Nome</th><th>Endereço</th><th>Contato</th><th>Horário</th><th>Salário</th><th>CNPJ</th><th>Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="novoFuncionarioModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="novoFuncionarioForm">
      <div class="modal-header">
        <h5 class="modal-title">Novo Funcionário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input class="form-control mb-2" name="nome" placeholder="Nome" required>
        <input class="form-control mb-2" name="endereco" placeholder="Endereço" required>
        <input class="form-control mb-2" name="contato" placeholder="Contato" required>
        <input class="form-control mb-2" name="horario" placeholder="Horário (ex: 08:00 - 17:00)" required>
        <input class="form-control mb-2" name="salario" placeholder="Salário" type="number" required>
        <input class="form-control mb-2" name="cnpj" placeholder="CNPJ" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";
let funcionarios = [];
let funcionarioEditandoId = null;

async function carregarFuncionarios() {
  const res = await fetch(`${API}/funcionarios/`);
  funcionarios = await res.json();
  renderizarTabela(funcionarios);
}

function renderizarTabela(lista) {
  const tbody = document.querySelector("#funcionariosTable tbody");
  tbody.innerHTML = "";
  lista.forEach(f => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.id ?? ""}</td>
      <td>${f.nome}</td>
      <td>${f.endereco}</td>
      <td>${f.contato}</td>
      <td>${f.horario}</td>
      <td>${f.salario}</td>
      <td>${f.cnpj}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="abrirEdicao(${f.id})">Editar</button>
        <button class="btn btn-sm btn-outline-danger" onclick="confirmarExclusao(${f.id})">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function abrirEdicao(id) {
  const f = funcionarios.find(f => f.id === id);
  if (!f) return;
  funcionarioEditandoId = id;
  const form = document.getElementById("novoFuncionarioForm");
  form.nome.value = f.nome;
  form.endereco.value = f.endereco;
  form.contato.value = f.contato;
  form.horario.value = f.horario;
  form.salario.value = f.salario;
  form.cnpj.value = f.cnpj;
  document.querySelector("#novoFuncionarioModal .modal-title").textContent = "Editar Funcionário";
  new bootstrap.Modal(document.getElementById("novoFuncionarioModal")).show();
}

function confirmarExclusao(id) {
  if (confirm("Deseja realmente excluir este funcionário?")) {
    deletarFuncionario(id);
  }
}

async function deletarFuncionario(id) {
  const res = await fetch(`${API}/funcionarios/${id}`, { method: "DELETE" });
  if (!res.ok) {
    const err = await res.json();
    alert("Erro: " + err.detail);
    return;
  }
  await carregarFuncionarios();
}

document.getElementById("novoFuncionarioForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    nome: form.nome.value,
    endereco: form.endereco.value,
    contato: form.contato.value,
    horario: form.horario.value,
    salario: parseFloat(form.salario.value),
    cnpj: form.cnpj.value,
    ativo: true
  };

  let url = `${API}/funcionarios/`;
  let method = "POST";

  if (funcionarioEditandoId) {
    url += funcionarioEditandoId;
    method = "PUT";
  }

  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const err = await res.json();
    alert("Erro: " + err.detail);
    return;
  }

  funcionarioEditandoId = null;
  form.reset();
  document.querySelector("#novoFuncionarioModal .modal-title").textContent = "Novo Funcionário";
  bootstrap.Modal.getInstance(document.getElementById("novoFuncionarioModal")).hide();
  await carregarFuncionarios();
});

document.getElementById("buscaFuncionario").addEventListener("input", () => {
  const termo = document.getElementById("buscaFuncionario").value.toLowerCase();
  const filtrados = funcionarios.filter(f =>
    f.nome.toLowerCase().includes(termo) || f.cnpj.toLowerCase().includes(termo)
  );
  renderizarTabela(filtrados);
});

carregarFuncionarios();
</script>
{% endblock %}
