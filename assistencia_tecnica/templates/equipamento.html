{% extends "base.html" %}
{% block title %}Equipamentos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Equipamentos</h2>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoEquipamentoModal">
    Novo Equipamento
  </button>
</div>

<table class="table table-striped" id="equipamentosTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Tipo / Marca</th>
      <th>Modelo</th>
      <th>Número de Série</th>
      <th>ID Cliente</th>
      <th>Nome do Cliente</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal Novo / Editar Equipamento -->
<div class="modal fade" id="equipamentoModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="equipamentoForm">
      <div class="modal-header">
        <h5 class="modal-title" id="equipamentoModalTitulo">Novo Equipamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="equipamentoId">
        <input class="form-control mb-2" id="tipo" placeholder="Tipo (ex: Notebook)" required>
        <input class="form-control mb-2" id="marca" placeholder="Marca (ex: Dell)" required>
        <input class="form-control mb-2" id="modelo" placeholder="Modelo" required>
        <input class="form-control mb-2" id="numero_serie" placeholder="Número de Série" required>

        <!-- Seleção de Cliente -->
        <select class="form-control mb-2" id="id_cliente" required>
          <option value="">Selecione um cliente</option>
        </select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";
let modoEdicao = false;

// === Função utilitária ===
function mostrarMensagem(msg, tipo = "success") {
  const alerta = document.createElement("div");
  alerta.className = `alert alert-${tipo} position-fixed top-0 end-0 m-3`;
  alerta.textContent = msg;
  alerta.style.zIndex = 1055;
  document.body.appendChild(alerta);
  setTimeout(() => alerta.remove(), 3000);
}

// === Carregar Equipamentos ===
async function carregarEquipamentos() {
  const res = await fetch(`${API}/equipamentos/`);
  const data = await res.json();
  const tbody = document.querySelector("#equipamentosTable tbody");
  tbody.innerHTML = "";

  data.forEach(eq => {
    const clienteId = eq.id_cliente ?? "—";
    const clienteNome = eq.nome_cliente ?? "—";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${eq.id_equipamento}</td>
      <td>${eq.tipo ?? ""} ${eq.marca ?? ""}</td>
      <td>${eq.modelo ?? ""}</td>
      <td>${eq.numero_serie ?? ""}</td>
      <td>${clienteId}</td>
      <td>${clienteNome}</td>
      <td>
        <button class="btn btn-sm btn-outline-warning me-2" onclick="abrirEdicao(${eq.id_equipamento})">Editar</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deletarEquipamento(${eq.id_equipamento})">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// === Carregar Clientes ===
async function carregarClientes() {
  const res = await fetch(`${API}/clientes/`);
  const clientes = await res.json();

  const select = document.getElementById("id_cliente");
  select.innerHTML = '<option value="">Selecione um cliente</option>';

  clientes.forEach(c => {
    const id = c.id_cliente ?? c.id;
    const nome = c.nome ?? c.nome_cliente ?? "Sem nome";
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${nome} (ID: ${id})`;
    select.appendChild(opt);
  });
}

// === Criar ou Editar Equipamento ===
document.getElementById("equipamentoForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const payload = {
    tipo: document.getElementById("tipo").value.trim(),
    marca: document.getElementById("marca").value.trim(),
    modelo: document.getElementById("modelo").value.trim(),
    numero_serie: document.getElementById("numero_serie").value.trim(),
    id_cliente: parseInt(document.getElementById("id_cliente").value)
  };

  const idEquip = document.getElementById("equipamentoId").value;
  const url = modoEdicao ? `${API}/equipamentos/${idEquip}` : `${API}/equipamentos/`;
  const method = modoEdicao ? "PUT" : "POST";

  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    bootstrap.Modal.getInstance(document.getElementById("equipamentoModal")).hide();
    mostrarMensagem(modoEdicao ? "Equipamento atualizado!" : "Equipamento criado!");
    await carregarEquipamentos();
  } else {
    const err = await res.json().catch(() => null);
    mostrarMensagem(err?.detail || "Erro ao salvar equipamento", "danger");
  }
});

// === Abrir Modal para Novo Equipamento ===
document.querySelector('[data-bs-target="#novoEquipamentoModal"]').addEventListener("click", () => {
  abrirNovo();
});

function abrirNovo() {
  modoEdicao = false;
  document.getElementById("equipamentoForm").reset();
  document.getElementById("equipamentoId").value = "";
  document.getElementById("equipamentoModalTitulo").textContent = "Novo Equipamento";
  bootstrap.Modal.getOrCreateInstance(document.getElementById("equipamentoModal")).show();
}

// === Abrir Modal para Editar Equipamento ===
async function abrirEdicao(id) {
  modoEdicao = true;
  const res = await fetch(`${API}/equipamentos/${id}`);
  if (!res.ok) return mostrarMensagem("Equipamento não encontrado", "danger");
  const eq = await res.json();

  document.getElementById("equipamentoId").value = eq.id_equipamento;
  document.getElementById("tipo").value = eq.tipo;
  document.getElementById("marca").value = eq.marca;
  document.getElementById("modelo").value = eq.modelo;
  document.getElementById("numero_serie").value = eq.numero_serie;
  document.getElementById("id_cliente").value = eq.id_cliente;

  document.getElementById("equipamentoModalTitulo").textContent = "Editar Equipamento";
  bootstrap.Modal.getOrCreateInstance(document.getElementById("equipamentoModal")).show();
}

// === Deletar Equipamento ===
async function deletarEquipamento(id) {
  if (!confirm("Deseja realmente excluir este equipamento?")) return;
  const res = await fetch(`${API}/equipamentos/${id}`, { method: "DELETE" });
  if (res.ok) {
    mostrarMensagem("Equipamento excluído com sucesso!");
    await carregarEquipamentos();
  } else {
    mostrarMensagem("Erro ao excluir equipamento", "danger");
  }
}

// === Inicialização ===
(async function init() {
  await carregarClientes();
  await carregarEquipamentos();
})();
</script>
{% endblock %}
